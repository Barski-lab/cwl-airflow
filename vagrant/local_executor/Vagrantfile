# -*- mode: ruby -*-
# vi: set ft=ruby :

$configure_airflow = <<-EOS
  echo Configuring Airflow
  sed -i 's/^executor.*/executor = LocalExecutor/g' /home/vagrant/airflow/airflow.cfg
  sed -i 's/^logging_level.*/logging_level = WARNING/g' /home/vagrant/airflow/airflow.cfg
  sed -i 's/^workers =.*/workers = 1/g' /home/vagrant/airflow/airflow.cfg
  sed -i 's/^worker_refresh_interval =.*/worker_refresh_interval = 10/g' /home/vagrant/airflow/airflow.cfg
  sed -i 's/^dagbag_import_timeout =.*/dagbag_import_timeout = 120/g' /home/vagrant/airflow/airflow.cfg
  sed -i 's/.*sql_alchemy_conn.*/sql_alchemy_conn = mysql:\\/\\/airflow:airflow@127.0.0.1:3306\\/airflow/g' /home/vagrant/airflow/airflow.cfg
  while ! mysqladmin ping -h 127.0.0.1 --silent; do
    echo Waiting for MySQL to start
    sleep 1
  done
  while ! systemctl is-active docker.service --quiet; do
    echo Waiting for Docker to start
    sleep 1
  done
  cwl-airflow init
EOS

$init_master = <<-EOS
  echo Running master init
  systemctl start airflow-scheduler.service
  systemctl start airflow-webserver.service
EOS

def mount_folders(machine)
  machine.vm.synced_folder "airflow/temp",    "/tmp/cwlairflow",               create: true
  machine.vm.synced_folder "airflow/dags",    "/home/vagrant/airflow/dags",    create: true
  machine.vm.synced_folder "airflow/jobs",    "/home/vagrant/airflow/jobs",    create: true
  machine.vm.synced_folder "airflow/demo",    "/home/vagrant/airflow/demo",    create: true
  machine.vm.synced_folder "airflow/results", "/home/vagrant/airflow/results", create: true
end

Vagrant.configure("2") do |machine|
  machine.vm.box = "michael_kotliar/cwl-airflow"
  machine.vm.network "forwarded_port", guest: 8080, host: 8080, host_ip: "127.0.0.1"
  machine.vm.network "forwarded_port", guest: 3306, host: 6603, host_ip: "127.0.0.1"
  machine.vm.define "master"
  machine.vm.hostname = "master"
  mount_folders(machine)
  machine.vm.provision "shell", inline: $configure_airflow, privileged: false, run: 'always'
  machine.vm.provision "shell", inline: $init_master,       privileged: true,  run: 'always'
  machine.vm.provider "virtualbox" do |vbox|
    vbox.memory = 4096
    vbox.cpus = 4
    vbox.name = "master"
  end
end
